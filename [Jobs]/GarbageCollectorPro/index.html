<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Garbage Collector Pro</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <link rel="stylesheet" href="assets/css/scanner.css">
</head>

<body>
    <h1 id="hideme1" style="text-align: center;">Garbage Collector Pro</h1>
    <div id="hideme2">
        <ul class="nav nav-tabs" role="tablist" style="margin-top: 20px;">
            <li class="nav-item" role="presentation"><a class="nav-link active" role="tab" data-toggle="tab" href="#tab-1">Routes</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" role="tabpanel" id="tab-1">
                <section>
                    <section id="amihub-elemnt-menubar">
                        <div class="top-menu-wrapper shadow">
                            <div class="row pt-1 pb-1 pl-3 pr-3 align-items-center top-menu-wrapper">
                                <div class="col col-lg-2 col-sm-12 col-space"><button class="btn btn-primary btn btn-outline-info btn-block" type="button" data-toggle="modal" data-target="#addSensorModal"><i class="fa fa-plus mr-2"></i>&nbsp;New Garbage Collection Route</button></div>
                            </div>
                        </div>
                        <div class="modal fade" role="dialog" tabindex="-1" id="addSensorModal" aria-labelledby="addSensorModalLabel">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header"><i class="fa fa-plus icon-dashboard"></i>
                                        <h4 class="modal-title">New Route</h4><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                                    </div>
                                    <div class="modal-body">
                                        <form>
                                            <div class="form-group"><label>Route Name</label><input class="form-control" type="text" id="fieldNameDashboard" placeholder="My Route"></div>
                                        </form>
                                        <p>Info: To configure the stops click on the route after creating it</p>
                                    </div>
                                    <div class="modal-footer"><button class="btn btn-light" id="btnModelCloseAddDashboard" type="button" data-dismiss="modal">Close</button><button id="routeCreateButton" class="btn btn-primary btn btn-outline-info btn-block" type="button">Create</button></div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <section id="container" class="row m-3">
                    </section>
                    <section>
                        <div class="infopanel show" style="display:none">
                            <div class="d-inline-block float-right mr-2 mt-1"><a class="close d-inline-block mr-2 mt-4" href="javascript:closeInfoPanel()" data-dismiss=".infopanel" aria-label="close"><span aria-hidden="true">x</span></a></div>
                            <div class="clear p-2 ml-1 mb-2 bold"><span id="routeNameSpan"><br />Route 1<br /><br /></span></div><hr><p id="paragraphueberschriftbus" style="font-weight: bold; font-size:20px;">Garbage Collection stops</p><div class="dropdown"><button class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false" type="button">Add Garbage Collection Stop </button>
    <div id="dropyyIsDown" class="dropdown-menu"></div>
</div><article id="stopsList" class="container">

  </article><hr><p id="paragraphueberschriftbus" style="font-weight: bold; font-size:20px;">Garbage Collection vehicle selction</p><div id="busListThing" class="form-check" style="margin-left: 0px;"><input type="checkbox" class="form-check-input" id="formCheck-1" style="margin-left: 0px;" /><label class="form-check-label" for="formCheck-1">Airport Shuttle Bus</label></div><hr><button class="btn btn-primary" id="buttonconfirm12" type="button">Confirm Changes</button><hr><button class="btn btn-danger" id="delteRoute" type="button">Delete Garbage Collection Route</button>
                        </div>
                    </section>
                </section>
            </div>
        </div>
    </div>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    <script src="assets/js/jquery-ui.min.js"></script>
    <script>
        let allBusses = [];

        window.addEventListener('load', function() {
            fetch(`https://${GetParentResourceName()}/getRoutes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({})
                }).then((response) => response.json())
              .then((data) => {
                allBusses = data.busses;
              });
        });

        $(document).on('click', '.dropdown-item', function (event) {
            let stop = event.target.closest(".dropdown-item");
            let id = stop.id;
            $(`#${id}`).remove();
            $("#stopsList").append(`<div id="${randomString(7)}" class="busStopDrag" draggable="true"><h3>${stop.innerHTML} <span class="actor"><i class="fa fa-chevron-down"></i></span></h3><p class="nameField12">Name: ${stop.innerHTML}</p><a class="deleteTheButton">Delete</a></div>`);
        });
        
        
        $(document).on('click', '#routeCreateButton', function (event) {
            let name = document.getElementById("fieldNameDashboard").value;
            fetch(`https://${GetParentResourceName()}/updateRoute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({
                        'name': name,
                        'busses': [],
                        'stops': []
                    })
            });
            setTimeout(function() {
            $("#container").empty();
            fetch(`https://${GetParentResourceName()}/getRoutes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({})
                }).then((response) => response.json())
                .then((data) => {
                    
                    allBusses = data.busses;
              });
            }, 750);
        });
        
       

        $(document).on('click', '#delteRoute', function (event) {
            let name = document.getElementById("routeNameSpan").innerText.split("\n").join("");
            fetch(`https://${GetParentResourceName()}/deleteRoute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({
                        'name': name
                    })
            });
            closeInfoPanel();
            setTimeout(function() {
            $("#container").empty();
            fetch(`https://${GetParentResourceName()}/getRoutes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({})
                }).then((response) => response.json())
              .then((data) => {
              
                allBusses = data.busses;
              });
            }, 750);
        });

        $(document).on('click', '.deleteTheButton', function (event) {
            let stop = event.target.closest(".busStopDrag");
            let id = stop.id;
            $("#dropyyIsDown").append(`<a id="${randomString(10)}" class="dropdown-item">${stop.querySelector(".nameField12").innerHTML.replace("Name: ", "")}</a>`);
            $(`#${id}`).remove();
        });

        $(document).on('click', '#buttonconfirm12', function (event) {
            let elementsArray = document.getElementsByClassName("busStopDrag");
            let busStops = [];
            for(var i = 0; i < elementsArray.length; i++)
            {
                busStops.push(elementsArray[i].querySelector(".nameField12").innerHTML.replace("Name: ", ""));
            }

            let bussesElements = document.getElementsByClassName("form-check-input");
            let busses = [];
            for(var i = 0; i < bussesElements.length; i++)
            {
                if (bussesElements[i].checked) {
                    busses.push(bussesElements[i].labels[0].innerHTML);
                }
            }

            fetch(`https://${GetParentResourceName()}/updateRoute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({
                        'name': document.getElementById("routeNameSpan").innerText.split("\n").join(""),
                        'busses': busses,
                        'stops': busStops
                    })
            });
            setTimeout(function() {
            $("#container").empty();
            fetch(`https://${GetParentResourceName()}/getRoutes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({})
                }).then((response) => response.json())
              .then((data) => {
              
                allBusses = data.busses;
              });
            }, 750);
            
        });

        $("#hideme1").hide();
        $("#hideme2").hide();
        $("body").css("background-color","transparent");
        window.addEventListener('message', (event) => {
            if (event.data.type === 'openEditor') {
                $("#hideme1").show();
                $("#hideme2").show();
                $("body").css("background-color","white");
            }
            if (event.data.type === 'addRoute') {
                $("#container").append(`<div class="col-sm-12 col-md-6 col-lg-4 col-xl-3 mb-3 routeClicker" id="${randomString(20)}"><a class="links" href="javascript:openInfoPanel()"><div class="card device-card"><div class="card-device-status bg-success"></div><div class="card-body"><h5 class="card-title">${event.data.name}</h5><p class="card-text">${event.data.stops} Stops</p><p class="card-text-small">Estimated Time: ${event.data.stops}min<br></p></div></div></a></div>`);
            }
        });
        $(document).on('click', '.routeClicker', function (event) {
            let name = event.target.closest(".routeClicker").getElementsByClassName("card-title")[0].innerHTML;
            fetch(`https://${GetParentResourceName()}/getRouteInfo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({
                        'route': name
                    })
            }).then((response) => response.json())
              .then((data) => {
                document.getElementById("routeNameSpan").innerHTML = `<br />${name}<br /><br />`;
                $("#stopsList").empty();
                data.stops.forEach((string, index) => {
                    $("#stopsList").append(`<div id="${randomString(7)}" class="busStopDrag" draggable="true"><h3>${string} <span class="actor"><i class="fa fa-chevron-down"></i></span></h3><p class="nameField12">Name: ${string}</p><a class="deleteTheButton">Delete</a></div>`);
                });
                $("#dropyyIsDown").empty();
                data.availableStops.forEach((string, index) => {
                    $("#dropyyIsDown").append(`<a id="${randomString(10)}" class="dropdown-item">${string}</a>`);
                });
                $("#busListThing").empty();
                
                data.selectedBusses.forEach((string, index) => {
                    let rS = randomString(15);
                    $("#busListThing").append(`<input type="checkbox" checked="true" class="form-check-input" id="${rS}" style="margin-left: 0px;" /><label class="form-check-label" for="${rS}">${string}</label>`);
                });
                allBusses.forEach((string, index) => {
                    if (!data.selectedBusses.includes(string))
                    {
                        let rS = randomString(15);
                        $("#busListThing").append(`<input type="checkbox" class="form-check-input" id="${rS}" style="margin-left: 0px;" /><label class="form-check-label" for="${rS}">${string}</label>`);
                    }
                });
              });
        });
        $("#stopsList").sortable();
        jQuery(document).on('keyup',function(evt) {
        if (evt.keyCode == 27) {
           $("#hideme1").hide();
           $("#hideme2").hide();
           $("body").css("background-color","transparent");

                fetch(`https://${GetParentResourceName()}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                    },
                    body: JSON.stringify({})
                });
            }
        });

        window.addEventListener('message', function(event) {
                if (event.data.type === 'playBusSound') {
                    let audio = new Audio('sounds/Announcement.mp3'); 
                    audio.addEventListener('ended', function(ev){
                        let audio = new Audio('sounds/NextStop.mp3'); 
                        audio.addEventListener('ended', function(ev){
                            setTimeout(function() {
                                let audio = new Audio('sounds/' + event.data.message.replace(/\s/g,'') + ".mp3"); 
                                audio.addEventListener('ended', function(ev){
                                    if (event.data.content === 'lastStop') {
                                        setTimeout(function() {
                                            let audio = new Audio('sounds/LastStop.mp3');
                                            audio.play();
                                        }, 150);
                                    }
                                });
                                audio.play();
                            }, 150);
                        });
                        audio.play();
                    });
                    audio.play();
		        } else if (event.data.type === 'playBusStopSound') {
                    let audio = new Audio('sounds/StopRequest.mp3'); 
                    audio.play();
                }
        });
        function randomString(length) {
		var result           = '';
		var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		var charactersLength = characters.length;
		for ( var i = 0; i < length; i++ ) {
		   result += characters.charAt(Math.floor(Math.random() * charactersLength));
		}
		return result;
	 }
    </script>

    <script src="https://cdn.jsdelivr.net/gh/akzhy/vara@master/src/vara.min.js" type="text/javascript"></script>
    <script src="https://d3js.org/d3.v6.js"></script>

</body>

</html>